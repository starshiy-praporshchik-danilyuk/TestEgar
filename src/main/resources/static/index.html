<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>test</title>

    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>



    <style>
        table {
            font-family: arial, sans-serif;
            border-collapse: collapse;
            width: 100%;
        }

        td, th {
            border: 1px solid #dddddd;
            text-align: left;
            padding: 8px;
        }

        tr:nth-child(even) {
            background-color: #dddddd;
        }
    </style>
</head>

<body>
<h3>Сервис учета стоимости ценных бумаг</h3>
<div>
    <form action="#">
        <input type="date" id="date" placeholder="Введите дату"  />
        <input type="text" id="name" placeholder="Название" />
        <input type="number" min=0 id="price" placeholder="Цена" />
        <button onclick="createInform()">Добавить</button>
    </form>

    <table id="informsList">

    </table>

    <div id="chart_div" style="width: 100%; height: 500px;"></div>

<script>

    setTimeout(loadInforms, 100);

    function createInform() {
    var informDate = document.getElementById("date").value;
    var informName = document.getElementById("name").value;
    var informPrice = document.getElementById("price").value;

    var xmlhttp = new XMLHttpRequest();
    xmlhttp.open("POST", "http://localhost:8081/inform/save", true);
    xmlhttp.setRequestHeader("Content-Type", "application/json");
    xmlhttp.send(JSON.stringify({date: informDate, name: informName, price: informPrice}));


    setTimeout(loadInforms, 100);
    setTimeout(drawChart, 100);
    }

    function loadInforms() {
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                var informs = JSON.parse(this.responseText);
                var html = '<tr>\n' +
                    '        <th>Inform date</th>\n' +
                    '        <th>Inform name</th>\n' +
                    '        <th>Inform price</th>\n' +
                    '        <th></th>\n' +
                    '        <th></th>\n' +
                    '    </tr>';
                for (var i = 0; i < informs.length; i++) {
                    var inform = informs[i];
                    console.log(inform);
                    html = html + '<tr><td><input type="date" id="val' + i + '" value=' + inform.date + ' /></td>' +
                        '        <td><input type="text" id="val' + (i + informs.length) + '" value=' + inform.name + ' /></td>' +
                        '        <td><input type="number" min=0 id="val' + (i + 2*informs.length) + '" value=' + inform.price + ' /></td>' +
                        '        <td><button onclick="updateInform(' + informs.length + ', ' + i + ', `' + inform.date + '`, `' + inform.name + '`)">Update</button></td>' +
                        '<td><button onclick="deleteInform(`' + inform.date + '`, `' + inform.name + '`)">Delete</button></td></tr>';
                }
                document.getElementById("informsList").innerHTML = html;
            }
        };
        xhttp.open("GET", "http://localhost:8081/inform/findAll", true);
        xhttp.send();
    }

    function updateInform(length, i, oldDate, oldName){

        var informDate = document.getElementById("val" + i).value;
        var informName = document.getElementById("val" + (i + length)).value;
        var informPrice = document.getElementById("val" + (i + 2*length)).value;

        var xmlhttp = new XMLHttpRequest();
        xmlhttp.open("PUT", "http://localhost:8081/inform/update", true);
        xmlhttp.setRequestHeader("Content-Type", "application/json");
        xmlhttp.send(JSON.stringify({newDate: informDate, newName: informName, newPrice: informPrice, oldDate: oldDate, oldName: oldName}));

        setTimeout(loadInforms, 100);
        setTimeout(drawChart, 100);
    }


    function deleteInform(informDate, informName){
        var xhttp1 = new XMLHttpRequest();
        xhttp1.open("DELETE", "http://localhost:8081/inform/delete", true);
        xhttp1.setRequestHeader("Content-Type", "application/json");
        xhttp1.send(JSON.stringify({date: informDate, name: informName}));

        setTimeout(loadInforms, 100);
        setTimeout(drawChart, 100);
    }

    type="text/javascript"
    google.charts.load('current', {'packages':['corechart']});
    google.charts.setOnLoadCallback(drawChart);

    function drawChart() {
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                var Arr = JSON.parse(this.responseText);

                var arr = [];
                for(var i = 0; i < Arr.length; i++) {
                    arr.push(Arr[i].date);
                }
                var arrSortDate = Array.from(new Set(arr));
                arrSortDate.sort();

                var arr1 = [];
                for(var j = 0; j < Arr.length; j++) {
                    arr1.push(Arr[j].name);
                }
                var arrSortName = Array.from(new Set(arr1));
                arrSortName.sort();
                console.log(arrSortName)


                var arrChart = [];
                for(var i = 0; i < arrSortDate.length; i++) {
                    arrChart[i] = [];
                    arrChart[i].push(arrSortDate[i]);
                    for(var j = 0; j < arrSortName.length; j++){
                        var val = null;
                        for (var k = 0; k < Arr.length; k++){
                            if (Arr[k].date == arrSortDate[i] && Arr[k].name == arrSortName[j]){
                                val = Arr[k].price;
                            }
                        }
                        arrChart[i].push(val);
                    }
                }

                arrSortName.unshift('Year');
                arrChart.unshift(arrSortName);
                var data = google.visualization.arrayToDataTable(arrChart);

                var options = {
                    title: 'График зависимости стоимости ценных бумаг от даты',
                    hAxis: {title: 'Дата',  titleTextStyle: {color: '#333'}},
                    vAxis: {title: 'Стоимость', minValue: 0},
                    interpolateNulls: true
                };

                var chart = new google.visualization.AreaChart(document.getElementById('chart_div'));
                chart.draw(data, options);

            }
        };
        xhttp.open("GET", "http://localhost:8081/inform/findAll", true);
        xhttp.send();

    }

</script>

</div>

</body>

</html>